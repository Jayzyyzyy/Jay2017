# TCP拥塞控制 #

## 一、原理

1. 在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏——产生拥塞(congestion)。所以需要进行控制
2. 出现资源拥塞的条件：
             对资源需求的总和 > 可用资源       

###1.流量控制与拥塞控制的区别与联系

- 拥塞控制所要做的都有一个前提，就是**网络能够承受现有的网络负荷**。
- 拥塞控制是一个**全局性的**过程，涉及**到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素**。 
- 流量控制往往指在给定的发送端和接收端之间的**点对点通信量的控制**。 
- 流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。

举例:

举个例子，<br>
1.宽带速率1Gb/s，网络只有两台机器，从一台主机传送数据到另一台，这需要流量控制，以保证接收方能正常接收数据。<br>
2.宽带速率1Gb/s，网络中有成千上万台机器，几万台主机发送到另外几万台，这需要拥塞控制，不然网络会瘫痪。所以折中一下，在连接数较少的情况下可能需要流量控制，配合拥塞控制。<br>


###2.拥塞控制方法

发送方维持一个叫做拥塞窗口 cwnd (congestion window)的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。

发送方控制拥塞窗口的**原则**是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。 

####(1)慢开始算法

1. 

	- 在主机刚刚开始发送报文段时可先设置拥塞窗口 cwnd = 1，即设置为一个最大报文段 MSS 的数值。
	- 在每收到一个对新的报文段的确认后，将拥塞窗口加 1，即增加一个 MSS 的数值。
	- 用这样的方法逐步增大发送端的拥塞窗口 cwnd，可以使分组注入到网络的速率更加合理。

2. 

![](http://onh97xzo0.bkt.clouddn.com/3-18.PNG)

- 使用慢开始算法后，每经过一个传输轮次，拥塞窗口 cwnd 就加倍。 
- 一个传输轮次所经历的时间其实就是往返时间 RTT。
- “传输轮次”更加强调：**把拥塞窗口 cwnd 所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认。**
- 例如，拥塞窗口 cwnd = 4，这时的往返时间 RTT 就是发送方连续发送 4 个报文段，并收到这 4 个报文段的确认，总共经历的时间。

<font color=red> 当 cwnd > ssthresh 时，停止使用慢开始算法而改用拥塞避免算法。
 </font>

####(2)拥塞避免算法

拥塞避免算法的**思路**是让拥塞窗口 cwnd 缓慢地增大，即**每经过一个往返时间 RTT** 就把发送方的拥塞窗口 cwnd 加 1，而不是加倍，使拥塞窗口 cwnd 按线性规律缓慢增长。

**“拥塞避免”是在拥塞避免阶段把拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞。** 

 
####(3)当网络出现拥塞时

- 无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有按时收到确认），就要把慢开始门限 ssthresh 设置为出现拥塞时的发送方窗口值的一半（但不能小于2）。
- 然后把拥塞窗口 cwnd 重新设置为 1，执行慢开始算法。
- 这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。 

举例：

![](http://onh97xzo0.bkt.clouddn.com/3-19.PNG)

拥塞控制:

- 乘法减小(MD)(慢启动、拥塞避免)

	“乘法减小“是指不论在慢开始阶段还是拥塞避免阶段，只要出现一次超时（即出现一次网络拥塞），就把慢开始门限值 ssthresh 设置为当前的拥塞窗口值乘以 0.5。
	当网络频繁出现拥塞时，ssthresh 值就下降得很快，以大大减少注入到网络中的分组数。 
	

- 加法增大(AI)(拥塞避免)

	“加法增大”是指执行拥塞避免算法后，在收到对所有报文段的确认后（即经过一个往返时间），就把拥塞窗口 cwnd增加一个 MSS 大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞。 

###(4)快速重传与恢复

####(a)快速重传

- 快重传算法首先要求接收方每收到一个失序的报文段后就立即发出重复确认。这样做可以让发送方及早知道有报文段没有到达接收方。 
- 发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段。 

![](http://onh97xzo0.bkt.clouddn.com/3-20.PNG)

####(b)快速恢复

当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，慢启动阈值 变为ssthresh=cwnd/2, cwnd=ssthresh，转为拥塞避免算法。

![](http://onh97xzo0.bkt.clouddn.com/3-21.PNG)

###3.拥塞控制状态转移

![](http://onh97xzo0.bkt.clouddn.com/3-22.PNG)