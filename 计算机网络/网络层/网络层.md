# 网络层 #

网络层向上只提供**简单灵活的、无连接的、尽最大努力交付**的数据报服务。

## 一、网际协议IP

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP
	-     (Address Resolution Protocol)
- 网际控制报文协议 ICMP
	-    (Internet Control Message Protocol)
- 网际组管理协议 IGMP
	-    (Internet Group Management Protocol)

![](http://onh97xzo0.bkt.clouddn.com/4-1.PNG)

###1.IP地址分类

####(1)分类的ip地址

每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号 net-id**，它标志主机（或路由器）所连接到的网络，而另一个字段则是**主机号 host-id**，它标志该主机（或路由器）。

ip地址可记为 ```IP 地址 ::= { <网络号>, <主机号>}```

![](http://onh97xzo0.bkt.clouddn.com/4-2.PNG)

注: 私有地址：

在这主要的三类地址中，绝大多数的IP地址都是公有地址，需要向国际互联网信息中心申请注册。
但是在IPv4地址协议中预留了3个IP地址段，作为私有地址，供**组织机构内部**使用。这三
个地址段分别位于A、B、C三类地址内：

- A类地址：10.0.0.0--10.255.255.255
- B类地址：172.16.0.0--172.31.255.255 
- C类地址：192.168.0.0--192.168.255.255



####(2)常用的三种类别的ip地址

![](http://onh97xzo0.bkt.clouddn.com/4-3.PNG)

####(3)IP地址与硬件地址的区别

![](http://onh97xzo0.bkt.clouddn.com/4-4.PNG)

###2.地址解析协议——ARP

每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的**局域网**上的各主机和路由器的 IP 地址到硬件地址的映射表。

1：首先，每个主机都会在自己的ARP缓冲区中建立一个ARP列表，以表示IP地址和MAC地址之间的对应关系。

2：当源主机要发送数据时，首先检查ARP列表中是否有对应IP地址的目的主机的MAC地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送ARP数据包，该数据包包括的内容有：源主机 IP地址，源主机MAC地址，目的主机的IP 地址。

3：当本网络的所有主机收到该ARP数据包时，首先检查数据包中的IP地址是否是自己的IP地址，如果不是，则忽略该数据包，如果是，则首先从数据包中取出源主机的IP和MAC地址写入到ARP列表中，如果已经存在，则覆盖，然后将自己的MAC地址写入ARP响应包中，告诉源主机自己是它想要找的MAC地址。

4：源主机收到ARP响应包后。将目的主机的IP和MAC地址写入ARP列表，并利用此信息发送数据。如果源主机一直没有收到ARP响应数据包，表示ARP查询失败。

**广播发送ARP请求，单播发送ARP响应。**

###3.IP数据报格式


- 一个 IP 数据报由首部和数据两部分组成。
- 首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。
- 在首部的固定部分的后面是一些可选字段，其长度是可变的。

![](http://onh97xzo0.bkt.clouddn.com/4-5.PNG) 

##二、划分子网

###1.从两级 IP 地址到三级 IP 地址。

1. 划分子网纯属一个**单位内部**的事情。**单位对外**仍然表现为**没有划分子网的网络**。

2. 从**主机号**借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。

	IP地址 ::= {<网络号>, <子网号>, <主机号>}

3.查找思路

- 凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。
- 然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。
- 最后就将 IP 数据报直接交付目的主机。 

**划分子网只是把 IP 地址的主机号 host-id 这部分进行再划分，而不改变 IP 地址原来的网络号 net-id**

###2.子网掩码

- 从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。
- 使用子网掩码(subnet mask)可以**找出 IP 地址中的子网部分**。  

![](http://onh97xzo0.bkt.clouddn.com/4-10.PNG)

**IP地址与子网掩码相与得到网络地址**

![](http://onh97xzo0.bkt.clouddn.com/4-11.PNG)


##三、其他协议

###1.ICMP协议

- 为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。
- ICMP 允许主机或**路由器报告差错情况**和**提供有关异常情况**的报告。
- ICMP 不是高层协议，而是 IP 层的协议。
- ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。   


